<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/feat/2d/FastCorner.js - igata.js API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="igata.js API" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Affine2d.html">Affine2d</a></li>
                                <li><a href="../classes/Bbf.html">Bbf</a></li>
                                <li><a href="../classes/Bitmap.html">Bitmap</a></li>
                                <li><a href="../classes/Blur.html">Blur</a></li>
                                <li><a href="../classes/Brightness.html">Brightness</a></li>
                                <li><a href="../classes/Cache.html">Cache</a></li>
                                <li><a href="../classes/Calc.html">Calc</a></li>
                                <li><a href="../classes/Convolution.html">Convolution</a></li>
                                <li><a href="../classes/Data_t.html">Data_t</a></li>
                                <li><a href="../classes/Estimator.html">Estimator</a></li>
                                <li><a href="../classes/FastCorner.html">FastCorner</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/Grayscale.html">Grayscale</a></li>
                                <li><a href="../classes/Haar.html">Haar</a></li>
                                <li><a href="../classes/HomoGraphy2d.html">HomoGraphy2d</a></li>
                                <li><a href="../classes/Igata.html">Igata</a></li>
                                <li><a href="../classes/Invert.html">Invert</a></li>
                                <li><a href="../classes/IVector.html">IVector</a></li>
                                <li><a href="../classes/Kanade.html">Kanade</a></li>
                                <li><a href="../classes/Keypoint_t.html">Keypoint_t</a></li>
                                <li><a href="../classes/LA.html">LA</a></li>
                                <li><a href="../classes/lev_table_t.html">lev_table_t</a></li>
                                <li><a href="../classes/LinearAlgebra.html">LinearAlgebra</a></li>
                                <li><a href="../classes/Matrix_t.html">Matrix_t</a></li>
                                <li><a href="../classes/MatrixMath.html">MatrixMath</a></li>
                                <li><a href="../classes/MM.html">MM</a></li>
                                <li><a href="../classes/MotionEstimator.html">MotionEstimator</a></li>
                                <li><a href="../classes/Node_t.html">Node_t</a></li>
                                <li><a href="../classes/Orb.html">Orb</a></li>
                                <li><a href="../classes/perform_one_point.html">perform_one_point</a></li>
                                <li><a href="../classes/Processing.html">Processing</a></li>
                                <li><a href="../classes/Pyramid_t.html">Pyramid_t</a></li>
                                <li><a href="../classes/Ransac_t.html">Ransac_t</a></li>
                                <li><a href="../classes/Sepia.html">Sepia</a></li>
                                <li><a href="../classes/Stack.html">Stack</a></li>
                                <li><a href="../classes/Table_t.html">Table_t</a></li>
                                <li><a href="../classes/Threshold.html">Threshold</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/Yape.html">Yape</a></li>
                                <li><a href="../classes/Yape06.html">Yape06</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Feat.html">Feat</a></li>
                                <li><a href="../modules/Igata.html">Igata</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/feat/2d/FastCorner.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
///**
// * license inazumatv.com
// * author (at)taikiken / http://inazumatv.com
// * date 15/09/10 - 14:52
// *
// * Copyright (c) 2011-2015 inazumatv.com, inc.
// *
// * Distributed under the terms of the MIT license.
// * http://www.opensource.org/licenses/mit-license.html
// *
// * This notice shall be included in all copies or substantial portions of the Software.
// *
// * for igata.js
// */
/*jslint -W016*/
/**
 * original code
 * http://inspirit.github.io/jsfeat/
 *
 * @module Igata
 * @submodule Feat
 */
( function ( window ) {

  &#x27;use strict&#x27;;

  var
    Igata = window.Igata,
    global = Igata;

  var Cache = global.Cache;

  var FastCorner = ( function () {

    // ------------------------------------------------------------------
    // private
    // ------------------------------------------------------------------

    /**
     * @for FastCorner
     * @property
     * @static
     * @private
     * @type {Int32Array}
     * @default new Int32Array([0, 3, 1, 3, 2, 2, 3, 1, 3, 0, 3, -1, 2, -2, 1, -3, 0, -3, -1, -3, -2, -2, -3, -1, -3, 0, -3, 1, -2, 2, -1, 3])
     */
    var offsets16 = new Int32Array([0, 3, 1, 3, 2, 2, 3, 1, 3, 0, 3, -1, 2, -2, 1, -3, 0, -3, -1, -3, -2, -2, -3, -1, -3, 0, -3, 1, -2, 2, -1, 3]);
    /**
     * @for FastCorner
     * @property threshold_tab
     * @static
     * @private
     * @type {Uint8Array}
     * @default new Uint8Array(512);
     */
    var threshold_tab = new Uint8Array(512);
    /**
     * @for FastCorner
     * @property pixel_off
     * @static
     * @private
     * @type {Int32Array}
     * @default new Int32Array(25);
     */
    var pixel_off = new Int32Array(25);
    /**
     * @for FastCorner
     * @property
     * @static
     * @private
     *
     * @type {Int32Array}
     * @default new Int32Array(25);
     */
    var score_diff = new Int32Array(25);
    /**
     * @for FastCorner
     * @property _threshold
     * @static
     * @default 25
     * @type {number}
     * @private
     */
    var _threshold = 20;

    /**
     * @method _cmp_offsets
     * @static
     * @param {Int32Array} pixel
     * @param {number} step
     * @param {number} pattern_size
     * @private
     */
    function _cmp_offsets ( pixel, step, pattern_size ) {

      var k = 0;
      var offsets = offsets16;

      for( ; k &lt; pattern_size; ++k ) {

        pixel[k] = offsets[k&lt;&lt;1] + offsets[(k&lt;&lt;1)+1] * step;

      }

      for( ; k &lt; 25; ++k ) {

        pixel[k] = pixel[k - pattern_size];

      }

    }

    /**
     * @method _cmp_score_16
     * @static
     * @param {Matrix_t} src
     * @param {number} off
     * @param {Int32Array} pixel
     * @param {Matrix_t} d
     * @param {number} threshold
     * @return {number}
     * @private
     */
    function _cmp_score_16 ( src, off, pixel, d, threshold ) {

      var N = 25, k = 0, v = src[off];
      var a0 = threshold,a=0,b0=0,b=0;

      for( ; k &lt; N; ++k ) {

        d[k] = v - src[off+pixel[k]];

      }

      for( k = 0; k &lt; 16; k += 2 ) {

        a = Math.min(d[k+1], d[k+2]);
        a = Math.min(a, d[k+3]);

        if( a &lt;= a0 ) {

          continue;

        }

        a = Math.min(a, d[k+4]);
        a = Math.min(a, d[k+5]);
        a = Math.min(a, d[k+6]);
        a = Math.min(a, d[k+7]);
        a = Math.min(a, d[k+8]);
        a0 = Math.max(a0, Math.min(a, d[k]));
        a0 = Math.max(a0, Math.min(a, d[k+9]));

      }

      b0 = -a0;
      for( k = 0; k &lt; 16; k += 2 ) {

        b = Math.max(d[k+1], d[k+2]);
        b = Math.max(b, d[k+3]);
        b = Math.max(b, d[k+4]);
        b = Math.max(b, d[k+5]);

        if( b &gt;= b0 ) {

          continue;

        }

        b = Math.max(b, d[k+6]);
        b = Math.max(b, d[k+7]);
        b = Math.max(b, d[k+8]);
        b0 = Math.min(b0, Math.max(b, d[k]));
        b0 = Math.min(b0, Math.max(b, d[k+9]));

      }

      return -b0-1;
    }

    /**
     * This is FAST corner detector, contributed to OpenCV by the author, Edward Rosten.
     *
     * The references are:
     *
     * Machine learning for high-speed corner detection,
     *
     * E. Rosten and T. Drummond, ECCV 2006
     *
     * Faster and better: A machine learning approach to corner detection
     *
     * E. Rosten, R. Porter and T. Drummond, PAMI, 2009
     *
     * ## Detects corners using the FAST algorithm.
     *
     *      // threshold on difference between intensity of the central pixel
     *      // and pixels of a circle around this pixel
     *      var threshold = 20;
     *      Igata.FastCorners.setThreshold(threshold);
     *
     *      var corners = [], border = 3;
     *
     *      // you should use preallocated keypoint_t array
     *      for(var i = 0; i &lt; img.cols*img.rows, ++i) {
     *
     *        corners[i] = new Igata.Keypoint_t(0,0,0,0);
     *
     *      }
     *
     *      // perform detection
     *      // returns the amount of detected corners
     *      var count = Igata.FastCorners.detect(img:Matrix_t, corners:Array, border = 3);
     *
     *
     * @class FastCorner
     * @static
     * @constructor
     */
    function FastCorner () {
      throw new Error( &#x27;FastCorner can\&#x27;t create instance.&#x27; );
    }

    var p = FastCorner.prototype;
    p.constructor = FastCorner;

    /**
     * @method setThreshold
     * @static
     * @param {number} threshold
     * @return {number}
     */
    FastCorner.setThreshold = function ( threshold ) {

      _threshold = Math.min(Math.max(threshold, 0), 255);

      for (var i = -255; i &lt;= 255; ++i) {

        threshold_tab[(i + 255)] = (i &lt; -_threshold ? 1 : (i &gt; _threshold ? 2 : 0));

      }

      return _threshold;

    };
    /**
     * @deprecated instead use FastCorner.setThreshold
     * @method set_threshold
     * @static
     * @param threshold
     */
    FastCorner.set_threshold = function ( threshold ) {

      return FastCorner.setThreshold( threshold );

    };

    /**
     * @method detect
     * @static
     * @param {Matrix_t} src
     * @param {Matrix_t} corners
     * @param {number=3} [border]
     * @return {number}
     */
    FastCorner.detect = function( src, corners, border ) {

      if (typeof border === &quot;undefined&quot;) { border = 3; }

      var K = 8, N = 25;
      var img = src.data, w = src.cols, h = src.rows;
      var i=0, j=0, k=0, vt=0, x=0, m3=0;
      var buf_node = Cache.getBuffer(3 * w);
      var cpbuf_node = Cache.getBuffer(((w+1)*3)&lt;&lt;2);
      var buf = buf_node.u8;
      var cpbuf = cpbuf_node.i32;
      var pixel = pixel_off;
      var sd = score_diff;
      var sy = Math.max(3, border);
      var ey = Math.min((h-2), (h-border));
      var sx = Math.max(3, border);
      var ex = Math.min((w - 3), (w - border));
      var _count = 0, corners_cnt = 0, pt;
      var score_func = _cmp_score_16;
      var thresh_tab = threshold_tab;
      var threshold = _threshold;

      var v=0,tab=0,d=0,ncorners=0,cornerpos=0,curr=0,ptr=0,prev=0,pprev=0;
      var jp1=0,jm1=0,score=0;

      _cmp_offsets(pixel, w, 16);

      // local vars are faster?
      var pixel0 = pixel[0];
      var pixel1 = pixel[1];
      var pixel2 = pixel[2];
      var pixel3 = pixel[3];
      var pixel4 = pixel[4];
      var pixel5 = pixel[5];
      var pixel6 = pixel[6];
      var pixel7 = pixel[7];
      var pixel8 = pixel[8];
      var pixel9 = pixel[9];
      var pixel10 = pixel[10];
      var pixel11 = pixel[11];
      var pixel12 = pixel[12];
      var pixel13 = pixel[13];
      var pixel14 = pixel[14];
      var pixel15 = pixel[15];

      var w3 = w*3;
      for(i = 0; i &lt; w3; ++i) {

        buf[i] = 0;

      }

      for(i = sy; i &lt; ey; ++i) {

        ptr = ((i * w) + sx)|0;
        m3 = (i - 3)%3;
        curr = (m3*w)|0;
        cornerpos = (m3*(w+1))|0;

        for (j = 0; j &lt; w; ++j) {

          buf[curr+j] = 0;

        }

        ncorners = 0;

        if( i &lt; (ey - 1) ) {

          j = sx;

          for( ; j &lt; ex; ++j, ++ptr ) {

            v = img[ptr];
            tab = ( - v + 255 );
            d = ( thresh_tab[tab+img[ptr+pixel0]] | thresh_tab[tab+img[ptr+pixel8]] );

            if( d === 0 ) {

              continue;

            }

            d &amp;= ( thresh_tab[tab+img[ptr+pixel2]] | thresh_tab[tab+img[ptr+pixel10]] );
            d &amp;= ( thresh_tab[tab+img[ptr+pixel4]] | thresh_tab[tab+img[ptr+pixel12]] );
            d &amp;= ( thresh_tab[tab+img[ptr+pixel6]] | thresh_tab[tab+img[ptr+pixel14]] );

            if( d === 0 ) {

              continue;

            }

            d &amp;= ( thresh_tab[tab+img[ptr+pixel1]] | thresh_tab[tab+img[ptr+pixel9]] );
            d &amp;= ( thresh_tab[tab+img[ptr+pixel3]] | thresh_tab[tab+img[ptr+pixel11]] );
            d &amp;= ( thresh_tab[tab+img[ptr+pixel5]] | thresh_tab[tab+img[ptr+pixel13]] );
            d &amp;= ( thresh_tab[tab+img[ptr+pixel7]] | thresh_tab[tab+img[ptr+pixel15]] );

            if( d &amp; 1 ) {

              vt = (v - threshold);
              _count = 0;

              for( k = 0; k &lt; N; ++k ) {

                x = img[(ptr+pixel[k])];

                if(x &lt; vt) {

                  ++_count;

                  if( _count &gt; K ) {

                    ++ncorners;
                    cpbuf[cornerpos+ncorners] = j;
                    buf[curr+j] = score_func(img, ptr, pixel, sd, threshold);
                    break;

                  }

                } else {

                  _count = 0;

                }

              }// for

            }// if

            if( d &amp; 2 ) {

              vt = (v + threshold);
              _count = 0;

              for( k = 0; k &lt; N; ++k ) {

                x = img[(ptr+pixel[k])];

                if(x &gt; vt) {

                  ++_count;

                  if( _count &gt; K ) {

                    ++ncorners;
                    cpbuf[cornerpos+ncorners] = j;
                    buf[curr+j] = score_func(img, ptr, pixel, sd, threshold);
                    break;

                  }

                } else {

                  _count = 0;

                }

              }

            }

          }

        }

        cpbuf[cornerpos+w] = ncorners;

        if ( i === sy ) {

          continue;

        }

        m3 = (i - 4 + 3)%3;
        prev = (m3*w)|0;
        cornerpos = (m3*(w+1))|0;
        m3 = (i - 5 + 3)%3;
        pprev = (m3*w)|0;

        ncorners = cpbuf[cornerpos+w];

        for( k = 0; k &lt; ncorners; ++k ) {

          j = cpbuf[cornerpos+k];
          jp1 = (j+1)|0;
          jm1 = (j-1)|0;
          score = buf[prev+j];

          if( (score &gt; buf[prev+jp1] &amp;&amp; score &gt; buf[prev+jm1] &amp;&amp;
            score &gt; buf[pprev+jm1] &amp;&amp; score &gt; buf[pprev+j] &amp;&amp; score &gt; buf[pprev+jp1] &amp;&amp;
            score &gt; buf[curr+jm1] &amp;&amp; score &gt; buf[curr+j] &amp;&amp; score &gt; buf[curr+jp1]) ) {

            // save corner
            pt = corners[corners_cnt];
            pt.x = j;
            pt.y = (i-1);
            pt.score = score;
            corners_cnt++;

          }

        }

      } // y loop

      Cache.putBuffer(buf_node);
      Cache.putBuffer(cpbuf_node);
      return corners_cnt;

    };

    return FastCorner;

  }() );

  // set default
  FastCorner.setThreshold( 20 );

  global.FastCorner = FastCorner;

}( window ) );
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
